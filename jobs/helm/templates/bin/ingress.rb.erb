#!/usr/bin/env ruby
# encoding: utf-8

require 'yaml'

INGRESS_YAML= <%= p('ingress') %>


INGRESS_YAML_TEST= <<~YAML
- name: dashboard-ingress
  namespace: kube-system
  definition:
      spec:
        rules:
        - host: ingress-ops.nd-int-cfapi.itn.intraorange
          http:
            paths:
            - backend:
                serviceName: kubernetes-dashboard
                servicePort: 443
              path: /dashboard

- name: grafana-ingress
  namespace: kube-system
  annotations:
  - name: nginx.ingress.kubernetes.io/rewrite-target
    value: '/'
  - name: nginx.ingress.kubernetes.io/secure-backends
    value : '"true"'

  definition:
    spec:
      rules:
      - host: ingress-ops.nd-int-cfapi.itn.intraorange
        http:
          paths:
          - backend:
              serviceName: grafana
              servicePort: 443
            path: /grafana

YAML


data = INGRESS_YAML
#data = YAML.load(INGRESS_YAML_TEST)

pclass= "<%= p('ingress_class') %>"
data.each { |ingress|
    pnamespace = ingress['namespace']
    pname = ingress['name']
    pspec = ingress['definition']
    pannotations =ingress['annotations']
    pfilename="/tmp/#{pname}.yml"

    File.open(pfilename, 'w+') do |f|
          f.puts("#{pspec.to_yaml}")
    end
    input_lines = File.readlines(pfilename)
    puts "#{input_lines}"
    input_lines[0]=""

    File.delete(pfilename)

    File.open(pfilename, 'w+') do |f|
      f.puts("apiVersion: extensions/v1beta1")
      f.puts("kind: Ingress")
      f.puts("metadata:")
      f.puts("  name: #{pname}")
      f.puts("  namespace: #{pnamespace}")
      f.puts("  annotations:")
      f.puts("    kubernetes.io/ingress.class: #{pclass}")
      if (pannotations != nil)
           pannotations.each{ |annotation|
            f.puts("    #{annotation['name']}: #{annotation['value']}")
           }
      end
      input_lines.each { |line|
        f.puts("#{line}")
        }
    end
    cmd = "kubectl apply -f #{pfilename} "
    system(cmd) or puts "#{cmd} : ACTION FAILED"
    File.delete(pfilename)
}



