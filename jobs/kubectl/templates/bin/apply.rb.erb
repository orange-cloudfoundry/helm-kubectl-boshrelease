#!/usr/bin/env ruby
# encoding: utf-8

require 'yaml'

CMDS_YAML= <%= p('commands') %>

data = CMDS_YAML
MAX_RETRIES = 5
SLEEP_DURATION = 5

cmdinit= "export KUBECONFIG=/var/vcap/jobs/kubectl/config/kubeconfig"
system("#{cmdinit};")

data.each { |apply|
    t= ""
    count=0
    pname = apply['name']

    pnamespace = apply['namespace']
    poptions = apply['options']
    pcmd = apply['cmd']
    pfile = apply['apply']

    cmd ="kubectl #{pcmd} "
    unless pnamespace.nil? || pnamespace == 0
        cmd = "#{cmd} --namespace #{pnamespace} "
    end
    unless poptions .nil? || poptions  == 0
            cmd = "#{cmd} #{apply['options']}"
        end
    unless pfile .nil? || pfile  == 0
            File.open("#{apply['name']}.yml", 'w') {|f| f.write pfile .to_yaml }
            cmd = "#{cmd} -f #{apply['name']}.yml"
        end

    # Begin the retryable operation
    retry_count = 0
    begin
      result=system(cmd)
      if result!=0 && retry_count < MAX_RETRIES
        puts "action failed: #{cmd} "
        retry_count += 1
        sleep SLEEP_DURATION
        puts "retry #{retry_count}: #{cmd}"
        result=system(cmd)
      end
      if result!=0
        puts "ACTION FAILED: #{cmd}/n/r No more retry action"
      end
      if result==0
         puts "ACTION SUCCESS: #{cmd}"
      end
    end

}


