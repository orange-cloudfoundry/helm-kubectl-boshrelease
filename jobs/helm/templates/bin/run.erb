#!/bin/sh

export KUBECONFIG=/var/vcap/jobs/helm/config/kubeconfig
export PATH=$PATH:/var/cap/packages/helm/bin:/var/cap/packages/kubectl/

#-------------------------------------------
echo "create credential for kubectl and helm"
#-------------------------------------------
director_name=<%= p('director.name') %>
deployment_name=<%= p('deployment.name') %>
password=<%= p('kubernetes.password') %>

tmp_ca_file="$(mktemp)"
echo <%= p('kubernetes.cluster_ca_certificate') %> > "${tmp_ca_file}"


cluster_name="kubo:${director_name}:${deployment_name}
user_name="kubo:${director_name}:${deployment_name}-admin"
context_name="kubo:${director_name}:${deployment_name}"


kubectl config set-cluster "${cluster_name}" --server="$address" --certificate-authority="${tmp_ca_file}" --embed-certs=true
kubectl config set-credentials "${user_name}" --token="${password}"
kubectl config set-context "${context_name}" --cluster="${cluster_name}" --user="${user_name}"
kubectl config use-context "${context_name}"
#-------------------------------------------
echo "execute kubectl to create a session-account for tiller"
#-------------------------------------------

kubectl apply -f /var/vcap/jobs/helm/config/rbac-config.yaml

#-------------------------------------------
echo "execute init helm, his repo , and the chart"
#-------------------------------------------

chmod +x /var/vcap/jobs/helm/bin/repository.rb
chmod +x /var/vcap/jobs/helm/bin/chart.rb

/var/vcap/jobs/helm/bin/./repository.rb
/var/vcap/jobs/helm/bin/./chart.rb


