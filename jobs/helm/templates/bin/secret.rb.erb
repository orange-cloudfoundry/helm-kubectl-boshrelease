#!/usr/bin/env ruby
# encoding: utf-8

require 'yaml'
require 'base64'

SECRETS_YAML= <%= p('secrets') %>


data = SECRETS_YAML

data.each { |secret|

    pnamespace = secret['namespace']
    pname = secret['name']
    pspec = secret['definition']
    pannotations =secret['annotations']
    ptype= secret['type']
    plabels= secret['labels']
    pfilename="/tmp/#{pname}.yml"



    File.open(pfilename, 'w+') do |f|
      f.puts("apiVersion: v1")
      f.puts("kind: secret")
      f.puts("metadata:")
      f.puts("  name: #{pname}")
      f.puts("  namespace: #{pnamespace}")
      f.puts("  annotations:")
      if (pannotations != nil)
           pannotations.each{ |annotation|
            f.puts("    #{annotation['name']}: #{annotation['value']}")
           }
      end
      f.puts("  labels:")
      if (plabels != nil)
            plabels.each{ |label|
            f.puts("    #{label['name']}: #{label['value']}")
           }
      end
      if (pspec != nil)
       pspec.each { |spec|
        b=  Base64.encode64(#{spec['value']})
        f.puts("#{spec['name']}: #{b})
        }
      f.puts("#{ptype}")
    end
    cmd = "kubectl apply -f #{pfilename} "
    system(cmd) or puts "#{cmd} : ACTION FAILED"
    File.delete(pfilename)
}



