#!/bin/bash

set -eux

export KUBECONFIG=/var/vcap/jobs/helm/config/kubeconfig
export PATH=$PATH:/var/vcap/packages/helm/linux-amd64/
export PATH=$PATH:/var/vcap/packages/kubectl/
export PATH="${BOSH_PACKAGES_DIR:-/var/vcap/packages}/ruby-2.4-r4/bin:$PATH"
export GEMRC="${BOSH_PACKAGES_DIR:-/var/vcap/packages}/ruby-2.4-r4/bosh/gemrc"


#-------------------------------------------
echo "create credential for kubectl and helm"

#-------------------------------------------
director_name=<%= p('director.name') %>
deployment_name=<%= p('deployment.name') %>
password=<%= p('kubernetes.password') %>
endpoint=<%= p('kubernetes.host') %>
port=<%= p('kubernetes.port') %>

echo ${PATH}
echo ${password}

cluster_name="kubo:${director_name}:${deployment_name}"
echo "cluster_name : ${cluster_name}"

user_name="kubo:${director_name}:${deployment_name}-admin"
echo "user_name : ${user_name}"

context_name="kubo:${director_name}:${deployment_name}"
echo "context_name : ${context_name}"

address="https://${endpoint}:${port}"

cat /var/vcap/jobs/helm/config/ca_cert.pem

kubectl config set-cluster "${cluster_name}" --server="${address}" --certificate-authority="/var/vcap/jobs/helm/config/ca_cert.pem" --embed-certs=true
echo "config set-cluster done "

kubectl config set-credentials "${user_name}" --token="${password}"
echo "config set-credentials done"

kubectl config set-context "${context_name}" --cluster="${cluster_name}" --user="${user_name}"
echo "config set-context done"

kubectl config use-context "${context_name}"
echo "config use-context done"

#-------------------------------------------
echo "execute kubectl to create a session-account for tiller"
#-------------------------------------------

kubectl apply -f /var/vcap/jobs/helm/config/rbac-config.yaml
chmod +x /var/vcap/jobs/helm/bin/ingress.rb
/var/vcap/jobs/helm/bin/./ingress.rb


#-------------------------------------------
echo "execute init helm, his repo , and the chart"
#-------------------------------------------
helm init --client-only
chmod +x /var/vcap/jobs/helm/bin/repository.rb
chmod +x /var/vcap/jobs/helm/bin/chart.rb

/var/vcap/jobs/helm/bin/./repository.rb
/var/vcap/jobs/helm/bin/./chart.rb


