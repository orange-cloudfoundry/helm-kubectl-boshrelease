#!/bin/bash
set -e

export http_proxy=<%= p('proxy.http') %>
export HTTP_PROXY=<%= p('proxy.http') %>
export https_proxy=<%= p('proxy.https') %>
export HTTPS_PROXY=<%= p('proxy.https') %>
export no_proxy=<%= p('proxy.noproxy') %>
export NO_PROXY=<%= p('proxy.noproxy') %>

export KUBECONFIG=/var/vcap/jobs/action/config/kubeconfig
export PATH=$PATH:/var/vcap/packages/helm/linux-amd64/
export PATH=$PATH:/var/vcap/packages/kubectl/
export PATH="${BOSH_PACKAGES_DIR:-/var/vcap/packages}/ruby-2.4-r4/bin:$PATH"
export GEMRC="${BOSH_PACKAGES_DIR:-/var/vcap/packages}/ruby-2.4-r4/bosh/gemrc"
export HELM_HOME=/var/vcap/store/helm/

mkdir -p /var/vcap/store/helm/
director_name=<%= p('director.name') %>
deployment_name=<%= p('deployment.name') %>
password=<%= p('kubernetes.password') %>
endpoint=<%= p('kubernetes.host') %>
port=<%= p('kubernetes.port') %>


cluster_name="kubo:${director_name}:${deployment_name}"
user_name="kubo:${director_name}:${deployment_name}-admin"
context_name=<%= p('kubernetes.usecontext') %>

<% if !p('kubernetes.config').empty? and p('kubernetes.config') != "nil" %>
cp /var/vcap/jobs/action/config/config /var/vcap/jobs/action/config/kubeconfig
<% else %>
address="https://${endpoint}:${port}"
kubectl config set-cluster "${cluster_name}" --server="${address}" --certificate-authority="/var/vcap/jobs/action/config/ca_cert.pem" --embed-certs=true
kubectl config set-credentials "${user_name}" --token="${password}"
kubectl config set-context "${context_name}" --cluster="${cluster_name}" --user="${user_name}"
<% end %>
kubectl config use-context "${context_name}"

